import { BaseController } from '@classytic/arc';
import categoryRepository from './category.repository.js';
import { NotFoundError, ConflictError } from '#shared/utils/errors.js';

/**
 * Category Controller
 *
 * Extends BaseController for standard CRUD.
 * Slug lookup and tree operations now handled by Arc presets.
 */
class CategoryController extends BaseController {
    constructor() {
        super(categoryRepository);

        this.syncProductCounts = this.syncProductCounts.bind(this);
    }

    // Note: getBySlug and getTree are now auto-generated by Arc presets

    /**
     * Recalculate product counts for all categories
     */
    async syncProductCounts(req, reply) {
        const result = await categoryRepository.recalculateAllCounts();
        return reply.send({ success: true, data: result });
    }

    /**
     * Override delete to check product count
     */
    async delete(context) {
        const category = await categoryRepository.getById(context.params.id);

        if (!category) {
            throw new NotFoundError('Category not found');
        }

        if (category.productCount > 0) {
            throw new ConflictError(`Cannot delete: ${category.productCount} products still use this category`);
        }

        await categoryRepository.delete(category._id);

        return {
            success: true,
            data: { message: 'Category deleted' },
            status: 200,
        };
    }
}

export default new CategoryController();
