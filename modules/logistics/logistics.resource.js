import { defineResource } from '@classytic/arc';
import logisticsController from './logistics.controller.js';
import permissions from '#config/permissions.js';
import {
  getDivisionsSchema,
  getDistrictsSchema,
  getAreasSchema,
  searchAreasSchema,
  getZonesSchema,
  estimateChargeSchema,
  calculateChargeSchema,
  getConfigSchema,
  trackShipmentSchema,
  cancelShipmentSchema,
  getPickupStoresSchema,
  circuitStatusSchema,
  resetCircuitSchema,
} from './logistics.schemas.js';

const logisticsResource = defineResource({
  name: 'logistics',
  displayName: 'Logistics',
  tag: 'Logistics',
  prefix: '/logistics',

  disableDefaultRoutes: true,

  additionalRoutes: [
    {
      method: 'GET',
      path: '/locations/divisions',
      summary: 'Get all divisions (8 divisions of Bangladesh)',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: getDivisionsSchema,
      handler: logisticsController.getDivisions,
    },
    {
      method: 'GET',
      path: '/locations/divisions/:division/districts',
      summary: 'Get districts by division',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: getDistrictsSchema,
      handler: logisticsController.getDistricts,
    },
    {
      method: 'GET',
      path: '/locations/areas',
      summary: 'Get all delivery areas',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: getAreasSchema,
      handler: logisticsController.getAreas,
    },
    {
      method: 'GET',
      path: '/locations/areas/search',
      summary: 'Search areas by name or post code',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: searchAreasSchema,
      handler: logisticsController.searchAreas,
    },
    {
      method: 'GET',
      path: '/locations/zones',
      summary: 'Get delivery zones with pricing info',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: getZonesSchema,
      handler: logisticsController.getDeliveryZones,
    },
    {
      method: 'GET',
      path: '/locations/estimate',
      summary: 'Estimate delivery charge (static calculation)',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: estimateChargeSchema,
      handler: logisticsController.estimateCharge,
    },
    {
      method: 'GET',
      path: '/charge',
      summary: 'Calculate charge via provider API',
      description: 'Fetches real-time pricing from the shipping provider',
      permissions: permissions.logistics.public,
      wrapHandler: false,
      schema: calculateChargeSchema,
      handler: logisticsController.calculateCharge,
    },
    {
      method: 'GET',
      path: '/config',
      summary: 'Get logistics configuration (read-only from .env)',
      description: 'Configuration is managed via environment variables. Restart server after changes to .env file.',
      permissions: permissions.logistics.admin,
      wrapHandler: false,
      schema: getConfigSchema,
      handler: logisticsController.getConfig,
    },
    {
      method: 'GET',
      path: '/shipments/:id/track',
      summary: 'Track shipment via provider API',
      description: 'Fetches live tracking info from the shipping provider. Use order ID or tracking number.',
      permissions: permissions.logistics.manage,
      wrapHandler: false,
      schema: trackShipmentSchema,
      handler: logisticsController.trackShipment,
    },
    {
      method: 'POST',
      path: '/shipments/:id/cancel',
      summary: 'Cancel shipment via provider API',
      description: 'Cancels the shipment in the provider system. Use order ID or tracking number.',
      permissions: permissions.logistics.manage,
      wrapHandler: false,
      schema: cancelShipmentSchema,
      handler: logisticsController.cancelShipment,
    },
    {
      method: 'GET',
      path: '/pickup-stores',
      summary: 'Get pickup stores from provider',
      permissions: permissions.logistics.manage,
      wrapHandler: false,
      schema: getPickupStoresSchema,
      handler: logisticsController.getPickupStores,
    },
    {
      method: 'GET',
      path: '/health/circuit-status',
      summary: 'Get circuit breaker status for all providers',
      permissions: permissions.logistics.admin,
      wrapHandler: false,
      schema: circuitStatusSchema,
      handler: logisticsController.getCircuitStatus,
    },
    {
      method: 'POST',
      path: '/health/circuit-reset/:provider',
      summary: 'Reset circuit breaker for a provider',
      permissions: permissions.logistics.admin,
      wrapHandler: false,
      schema: resetCircuitSchema,
      handler: logisticsController.resetProviderCircuit,
    },
  ],
});

export default logisticsResource;
